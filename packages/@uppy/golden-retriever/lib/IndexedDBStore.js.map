{"version":3,"names":["indexedDB","window","webkitIndexedDB","mozIndexedDB","OIndexedDB","msIndexedDB","isSupported","DB_NAME","STORE_NAME","DEFAULT_EXPIRY","DB_VERSION","migrateExpiration","store","request","openCursor","onsuccess","event","cursor","target","result","entry","value","expires","Date","now","update","connect","dbName","open","Promise","resolve","reject","onupgradeneeded","db","transaction","currentTarget","oldVersion","createObjectStore","keyPath","createIndex","unique","objectStore","oncomplete","onerror","waitForRequest","cleanedUp","IndexedDBStore","constructor","opts","storeName","maxFileSize","maxTotalSize","name","createConnection","ready","cleanup","then","key","fileID","list","index","getAll","IDBKeyRange","only","files","forEach","file","data","get","id","getSize","size","continue","Error","put","add","delete","upperBound","close"],"sources":["IndexedDBStore.js"],"sourcesContent":["const indexedDB = typeof window !== 'undefined'\n  && (window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.OIndexedDB || window.msIndexedDB)\n\nconst isSupported = !!indexedDB\n\nconst DB_NAME = 'uppy-blobs'\nconst STORE_NAME = 'files' // maybe have a thumbnail store in the future\nconst DEFAULT_EXPIRY = 24 * 60 * 60 * 1000 // 24 hours\nconst DB_VERSION = 3\n\n// Set default `expires` dates on existing stored blobs.\nfunction migrateExpiration (store) {\n  const request = store.openCursor()\n  request.onsuccess = (event) => {\n    const cursor = event.target.result\n    if (!cursor) {\n      return\n    }\n    const entry = cursor.value\n    entry.expires = Date.now() + DEFAULT_EXPIRY\n    cursor.update(entry)\n  }\n}\n\nfunction connect (dbName) {\n  const request = indexedDB.open(dbName, DB_VERSION)\n  return new Promise((resolve, reject) => {\n    request.onupgradeneeded = (event) => {\n      const db = event.target.result\n      const { transaction } = event.currentTarget\n\n      if (event.oldVersion < 2) {\n        // Added in v2: DB structure changed to a single shared object store\n        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' })\n        store.createIndex('store', 'store', { unique: false })\n      }\n\n      if (event.oldVersion < 3) {\n        // Added in v3\n        const store = transaction.objectStore(STORE_NAME)\n        store.createIndex('expires', 'expires', { unique: false })\n\n        migrateExpiration(store)\n      }\n\n      transaction.oncomplete = () => {\n        resolve(db)\n      }\n    }\n    request.onsuccess = (event) => {\n      resolve(event.target.result)\n    }\n    request.onerror = reject\n  })\n}\n\nfunction waitForRequest (request) {\n  return new Promise((resolve, reject) => {\n    request.onsuccess = (event) => {\n      resolve(event.target.result)\n    }\n    request.onerror = reject\n  })\n}\n\nlet cleanedUp = false\nclass IndexedDBStore {\n  constructor (opts) {\n    this.opts = {\n      dbName: DB_NAME,\n      storeName: 'default',\n      expires: DEFAULT_EXPIRY, // 24 hours\n      maxFileSize: 10 * 1024 * 1024, // 10 MB\n      maxTotalSize: 300 * 1024 * 1024, // 300 MB\n      ...opts,\n    }\n\n    this.name = this.opts.storeName\n\n    const createConnection = () => {\n      return connect(this.opts.dbName)\n    }\n\n    if (!cleanedUp) {\n      cleanedUp = true\n      this.ready = IndexedDBStore.cleanup()\n        .then(createConnection, createConnection)\n    } else {\n      this.ready = createConnection()\n    }\n  }\n\n  key (fileID) {\n    return `${this.name}!${fileID}`\n  }\n\n  /**\n   * List all file blobs currently in the store.\n   */\n  list () {\n    return this.ready.then((db) => {\n      const transaction = db.transaction([STORE_NAME], 'readonly')\n      const store = transaction.objectStore(STORE_NAME)\n      const request = store.index('store')\n        .getAll(IDBKeyRange.only(this.name))\n      return waitForRequest(request)\n    }).then((files) => {\n      const result = {}\n      files.forEach((file) => {\n        result[file.fileID] = file.data\n      })\n      return result\n    })\n  }\n\n  /**\n   * Get one file blob from the store.\n   */\n  get (fileID) {\n    return this.ready.then((db) => {\n      const transaction = db.transaction([STORE_NAME], 'readonly')\n      const request = transaction.objectStore(STORE_NAME)\n        .get(this.key(fileID))\n      return waitForRequest(request)\n    }).then((result) => ({\n      id: result.data.fileID,\n      data: result.data.data,\n    }))\n  }\n\n  /**\n   * Get the total size of all stored files.\n   *\n   * @private\n   */\n  getSize () {\n    return this.ready.then((db) => {\n      const transaction = db.transaction([STORE_NAME], 'readonly')\n      const store = transaction.objectStore(STORE_NAME)\n      const request = store.index('store')\n        .openCursor(IDBKeyRange.only(this.name))\n      return new Promise((resolve, reject) => {\n        let size = 0\n        request.onsuccess = (event) => {\n          const cursor = event.target.result\n          if (cursor) {\n            size += cursor.value.data.size\n            cursor.continue()\n          } else {\n            resolve(size)\n          }\n        }\n        request.onerror = () => {\n          reject(new Error('Could not retrieve stored blobs size'))\n        }\n      })\n    })\n  }\n\n  /**\n   * Save a file in the store.\n   */\n  put (file) {\n    if (file.data.size > this.opts.maxFileSize) {\n      return Promise.reject(new Error('File is too big to store.'))\n    }\n    return this.getSize().then((size) => {\n      if (size > this.opts.maxTotalSize) {\n        return Promise.reject(new Error('No space left'))\n      }\n      return this.ready\n    }).then((db) => {\n      const transaction = db.transaction([STORE_NAME], 'readwrite')\n      const request = transaction.objectStore(STORE_NAME).add({\n        id: this.key(file.id),\n        fileID: file.id,\n        store: this.name,\n        expires: Date.now() + this.opts.expires,\n        data: file.data,\n      })\n      return waitForRequest(request)\n    })\n  }\n\n  /**\n   * Delete a file blob from the store.\n   */\n  delete (fileID) {\n    return this.ready.then((db) => {\n      const transaction = db.transaction([STORE_NAME], 'readwrite')\n      const request = transaction.objectStore(STORE_NAME)\n        .delete(this.key(fileID))\n      return waitForRequest(request)\n    })\n  }\n\n  /**\n   * Delete all stored blobs that have an expiry date that is before Date.now().\n   * This is a static method because it deletes expired blobs from _all_ Uppy instances.\n   */\n  static cleanup () {\n    return connect(DB_NAME).then((db) => {\n      const transaction = db.transaction([STORE_NAME], 'readwrite')\n      const store = transaction.objectStore(STORE_NAME)\n      const request = store.index('expires')\n        .openCursor(IDBKeyRange.upperBound(Date.now()))\n      return new Promise((resolve, reject) => {\n        request.onsuccess = (event) => {\n          const cursor = event.target.result\n          if (cursor) {\n            cursor.delete() // Ignoring return value â€¦ it's not terrible if this goes wrong.\n            cursor.continue()\n          } else {\n            resolve(db)\n          }\n        }\n        request.onerror = reject\n      })\n    }).then((db) => {\n      db.close()\n    })\n  }\n}\n\nIndexedDBStore.isSupported = isSupported\n\nexport default IndexedDBStore\n"],"mappings":"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"}