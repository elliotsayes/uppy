{"version":3,"names":["findUppyInstances","instances","i","localStorage","length","key","test","push","slice","maybeParse","str","JSON","parse","err","cleanedUp","MetaDataStore","constructor","opts","expires","name","storeName","cleanup","load","savedState","getItem","data","metadata","save","Date","now","state","stringify","setItem","instanceID","removeItem","instanceIDs","forEach","id","obj"],"sources":["MetaDataStore.js"],"sourcesContent":["/**\n * Get uppy instance IDs for which state is stored.\n */\nfunction findUppyInstances () {\n  const instances = []\n  for (let i = 0; i < localStorage.length; i++) {\n    const key = localStorage.key(i)\n    if (/^uppyState:/.test(key)) {\n      instances.push(key.slice('uppyState:'.length))\n    }\n  }\n  return instances\n}\n\n/**\n * Try to JSON-parse a string, return null on failure.\n */\nfunction maybeParse (str) {\n  try {\n    return JSON.parse(str)\n  } catch (err) {\n    return null\n  }\n}\n\nlet cleanedUp = false\nexport default class MetaDataStore {\n  constructor (opts) {\n    this.opts = {\n      expires: 24 * 60 * 60 * 1000, // 24 hours\n      ...opts,\n    }\n    this.name = `uppyState:${opts.storeName}`\n\n    if (!cleanedUp) {\n      cleanedUp = true\n      MetaDataStore.cleanup()\n    }\n  }\n\n  /**\n   *\n   */\n  load () {\n    const savedState = localStorage.getItem(this.name)\n    if (!savedState) return null\n    const data = maybeParse(savedState)\n    if (!data) return null\n\n    // Upgrade pre-0.20.0 uppyState: it used to be just a flat object,\n    // without `expires`.\n    if (!data.metadata) {\n      this.save(data)\n      return data\n    }\n\n    return data.metadata\n  }\n\n  save (metadata) {\n    const expires = Date.now() + this.opts.expires\n    const state = JSON.stringify({\n      metadata,\n      expires,\n    })\n    localStorage.setItem(this.name, state)\n  }\n\n  /**\n   * Remove all expired state.\n   */\n  static cleanup (instanceID) {\n    if (instanceID) {\n      localStorage.removeItem(`uppyState:${instanceID}`)\n      return\n    }\n\n    const instanceIDs = findUppyInstances()\n    const now = Date.now()\n    instanceIDs.forEach((id) => {\n      const data = localStorage.getItem(`uppyState:${id}`)\n      if (!data) return\n      const obj = maybeParse(data)\n      if (!obj) return\n\n      if (obj.expires && obj.expires < now) {\n        localStorage.removeItem(`uppyState:${id}`)\n      }\n    })\n  }\n}\n"],"mappings":"AAAA;AACA;AACA;AACA,SAASA,iBAAT,GAA8B;EAC5B,MAAMC,SAAS,GAAG,EAAlB;;EACA,KAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGC,YAAY,CAACC,MAAjC,EAAyCF,CAAC,EAA1C,EAA8C;IAC5C,MAAMG,GAAG,GAAGF,YAAY,CAACE,GAAb,CAAiBH,CAAjB,CAAZ;;IACA,IAAI,cAAcI,IAAd,CAAmBD,GAAnB,CAAJ,EAA6B;MAC3BJ,SAAS,CAACM,IAAV,CAAeF,GAAG,CAACG,KAAJ,CAAU,aAAaJ,MAAvB,CAAf;IACD;EACF;;EACD,OAAOH,SAAP;AACD;AAED;AACA;AACA;;;AACA,SAASQ,UAAT,CAAqBC,GAArB,EAA0B;EACxB,IAAI;IACF,OAAOC,IAAI,CAACC,KAAL,CAAWF,GAAX,CAAP;EACD,CAFD,CAEE,OAAOG,GAAP,EAAY;IACZ,OAAO,IAAP;EACD;AACF;;AAED,IAAIC,SAAS,GAAG,KAAhB;AACA,eAAe,MAAMC,aAAN,CAAoB;EACjCC,WAAW,CAAEC,IAAF,EAAQ;IACjB,KAAKA,IAAL,GAAY;MACVC,OAAO,EAAE,KAAK,EAAL,GAAU,EAAV,GAAe,IADd;MACoB;MAC9B,GAAGD;IAFO,CAAZ;IAIA,KAAKE,IAAL,GAAa,aAAYF,IAAI,CAACG,SAAU,EAAxC;;IAEA,IAAI,CAACN,SAAL,EAAgB;MACdA,SAAS,GAAG,IAAZ;MACAC,aAAa,CAACM,OAAd;IACD;EACF;EAED;AACF;AACA;;;EACEC,IAAI,GAAI;IACN,MAAMC,UAAU,GAAGpB,YAAY,CAACqB,OAAb,CAAqB,KAAKL,IAA1B,CAAnB;IACA,IAAI,CAACI,UAAL,EAAiB,OAAO,IAAP;IACjB,MAAME,IAAI,GAAGhB,UAAU,CAACc,UAAD,CAAvB;IACA,IAAI,CAACE,IAAL,EAAW,OAAO,IAAP,CAJL,CAMN;IACA;;IACA,IAAI,CAACA,IAAI,CAACC,QAAV,EAAoB;MAClB,KAAKC,IAAL,CAAUF,IAAV;MACA,OAAOA,IAAP;IACD;;IAED,OAAOA,IAAI,CAACC,QAAZ;EACD;;EAEDC,IAAI,CAAED,QAAF,EAAY;IACd,MAAMR,OAAO,GAAGU,IAAI,CAACC,GAAL,KAAa,KAAKZ,IAAL,CAAUC,OAAvC;IACA,MAAMY,KAAK,GAAGnB,IAAI,CAACoB,SAAL,CAAe;MAC3BL,QAD2B;MAE3BR;IAF2B,CAAf,CAAd;IAIAf,YAAY,CAAC6B,OAAb,CAAqB,KAAKb,IAA1B,EAAgCW,KAAhC;EACD;EAED;AACF;AACA;;;EACgB,OAAPT,OAAO,CAAEY,UAAF,EAAc;IAC1B,IAAIA,UAAJ,EAAgB;MACd9B,YAAY,CAAC+B,UAAb,CAAyB,aAAYD,UAAW,EAAhD;MACA;IACD;;IAED,MAAME,WAAW,GAAGnC,iBAAiB,EAArC;IACA,MAAM6B,GAAG,GAAGD,IAAI,CAACC,GAAL,EAAZ;IACAM,WAAW,CAACC,OAAZ,CAAqBC,EAAD,IAAQ;MAC1B,MAAMZ,IAAI,GAAGtB,YAAY,CAACqB,OAAb,CAAsB,aAAYa,EAAG,EAArC,CAAb;MACA,IAAI,CAACZ,IAAL,EAAW;MACX,MAAMa,GAAG,GAAG7B,UAAU,CAACgB,IAAD,CAAtB;MACA,IAAI,CAACa,GAAL,EAAU;;MAEV,IAAIA,GAAG,CAACpB,OAAJ,IAAeoB,GAAG,CAACpB,OAAJ,GAAcW,GAAjC,EAAsC;QACpC1B,YAAY,CAAC+B,UAAb,CAAyB,aAAYG,EAAG,EAAxC;MACD;IACF,CATD;EAUD;;AA/DgC"}