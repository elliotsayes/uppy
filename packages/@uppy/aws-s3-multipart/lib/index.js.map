{"version":3,"names":["BasePlugin","Socket","Provider","RequestClient","EventTracker","emitSocketProgress","getSocketHost","RateLimitedQueue","createAbortError","packageJson","MultipartUploader","assertServerError","res","error","Error","message","Object","assign","throwIfAborted","signal","aborted","cause","reason","HTTPCommunicationQueue","constructor","requests","options","setS3MultipartState","WeakMap","setOptions","wrapPromiseFunction","abortMultipartUpload","createMultipartUpload","priority","signPart","listParts","completeMultipartUpload","retryDelays","values","uploadPartBytes","Infinity","getUploadId","file","cachedResult","get","data","promise","abortPromise","abort","delete","addEventListener","once","set","then","result","removeEventListener","abortFileUpload","uploadFile","chunks","uploadId","key","parts","Promise","all","map","chunk","i","uploadChunk","abortOn","resumeUploadFile","alreadyUploadedParts","partNumber","alreadyUploadedInfo","find","PartNumber","ETag","body","signature","err","status","source","isPaused","limit","next","done","value","rateLimit","resolve","setTimeout","navigator","onLine","pause","window","resume","Symbol","for","AwsS3Multipart","uppy","opts","cFile","getFile","id","setFileState","s3Multipart","Client","remote","providerOptions","provider","client","tus","url","post","protocol","size","metadata","meta","token","setCompanionHeaders","companionHeaders","type","title","defaultOptions","bind","prepareUploadParts","presignedUrls","headers","number","upload","rateLimitedQueue","uploaders","create","uploaderEvents","uploaderSockets","newOptions","resetUploaderReferences","fileID","really","remove","close","assertHost","method","companionUrl","keys","forEach","toString","filename","name","encodeURIComponent","uploadIdEnc","undefined","expires","reject","xhr","XMLHttpRequest","open","setRequestHeader","responseType","timeout","onabort","cleanup","onProgress","ev","target","responseText","includes","etag","getResponseHeader","onComplete","send","bytesUploaded","bytesTotal","emit","uploader","onError","log","onSuccess","uploadObject","uploadResp","uploadURL","location","onPartComplete","part","companionComm","getChunkSize","onFileRemove","removed","onCancelAll","onFilePause","start","onPauseAll","onResumeAll","progress","uploadStarted","isRestored","uploadRemote","serverToken","connectToServerSocket","queuedRequest","host","socket","run","onRetry","isOpen","onRetryAll","on","progressData","errData","fileIDs","length","promises","isRemote","cb","targetFileID","eventHandler","install","capabilities","getState","setState","resumableUploads","addPreProcessor","addUploader","uninstall","removePreProcessor","removeUploader","VERSION","version"],"sources":["index.js"],"sourcesContent":["import BasePlugin from '@uppy/core/lib/BasePlugin.js'\nimport { Socket, Provider, RequestClient } from '@uppy/companion-client'\nimport EventTracker from '@uppy/utils/lib/EventTracker'\nimport emitSocketProgress from '@uppy/utils/lib/emitSocketProgress'\nimport getSocketHost from '@uppy/utils/lib/getSocketHost'\nimport { RateLimitedQueue } from '@uppy/utils/lib/RateLimitedQueue'\n\nimport { createAbortError } from '@uppy/utils/lib/AbortController'\nimport packageJson from '../package.json'\nimport MultipartUploader from './MultipartUploader.js'\n\nfunction assertServerError (res) {\n  if (res && res.error) {\n    const error = new Error(res.message)\n    Object.assign(error, res.error)\n    throw error\n  }\n  return res\n}\n\nfunction throwIfAborted (signal) {\n  if (signal?.aborted) { throw createAbortError('The operation was aborted', { cause: signal.reason }) }\n}\n\nclass HTTPCommunicationQueue {\n  #abortMultipartUpload\n\n  #cache = new WeakMap()\n\n  #createMultipartUpload\n\n  #fetchSignature\n\n  #listParts\n\n  #previousRetryDelay\n\n  #requests\n\n  #retryDelayIterator\n\n  #sendCompletionRequest\n\n  #setS3MultipartState\n\n  #uploadPartBytes\n\n  constructor (requests, options, setS3MultipartState) {\n    this.#requests = requests\n    this.#setS3MultipartState = setS3MultipartState\n    this.setOptions(options)\n  }\n\n  setOptions (options) {\n    const requests = this.#requests\n\n    if ('abortMultipartUpload' in options) {\n      this.#abortMultipartUpload = requests.wrapPromiseFunction(options.abortMultipartUpload)\n    }\n    if ('createMultipartUpload' in options) {\n      this.#createMultipartUpload = requests.wrapPromiseFunction(options.createMultipartUpload, { priority:-1 })\n    }\n    if ('signPart' in options) {\n      this.#fetchSignature = requests.wrapPromiseFunction(options.signPart)\n    }\n    if ('listParts' in options) {\n      this.#listParts = requests.wrapPromiseFunction(options.listParts)\n    }\n    if ('completeMultipartUpload' in options) {\n      this.#sendCompletionRequest = requests.wrapPromiseFunction(options.completeMultipartUpload)\n    }\n    if ('retryDelays' in options) {\n      this.#retryDelayIterator = options.retryDelays?.values()\n    }\n    if ('uploadPartBytes' in options) {\n      this.#uploadPartBytes = requests.wrapPromiseFunction(options.uploadPartBytes, { priority:Infinity })\n    }\n  }\n\n  async #shouldRetry (err) {\n    const requests = this.#requests\n    const status = err?.source?.status\n\n    // TODO: this retry logic is taken out of Tus. We should have a centralized place for retrying,\n    // perhaps the rate limited queue, and dedupe all plugins with that.\n    if (status == null) {\n      return false\n    }\n    if (status === 403 && err.message === 'Request has expired') {\n      if (!requests.isPaused) {\n        // We don't want to exhaust the retryDelayIterator as long as there are\n        // more than one request in parallel, to give slower connection a chance\n        // to catch up with the expiry set in Companion.\n        if (requests.limit === 1 || this.#previousRetryDelay == null) {\n          const next = this.#retryDelayIterator?.next()\n          if (next == null || next.done) {\n            return false\n          }\n          // If there are more than 1 request done in parallel, the RLQ limit is\n          // decreased and the failed request is requeued after waiting for a bit.\n          // If there is only one request in parallel, the limit can't be\n          // decreased, so we iterate over `retryDelayIterator` as we do for\n          // other failures.\n          // `#previousRetryDelay` caches the value so we can re-use it next time.\n          this.#previousRetryDelay = next.value\n        }\n        // No need to stop the other requests, we just want to lower the limit.\n        requests.rateLimit(0)\n        await new Promise(resolve => setTimeout(resolve, this.#previousRetryDelay))\n      }\n    } else if (status === 429) {\n      // HTTP 429 Too Many Requests => to avoid the whole download to fail, pause all requests.\n      if (!requests.isPaused) {\n        const next = this.#retryDelayIterator?.next()\n        if (next == null || next.done) {\n          return false\n        }\n        requests.rateLimit(next.value)\n      }\n    } else if (status > 400 && status < 500 && status !== 409) {\n      // HTTP 4xx, the server won't send anything, it's doesn't make sense to retry\n      return false\n    } else if (typeof navigator !== 'undefined' && navigator.onLine === false) {\n      // The navigator is offline, let's wait for it to come back online.\n      if (!requests.isPaused) {\n        requests.pause()\n        window.addEventListener('online', () => {\n          requests.resume()\n        }, { once: true })\n      }\n    } else {\n      // Other error code means the request can be retried later.\n      const next = this.#retryDelayIterator?.next()\n      if (next == null || next.done) {\n        return false\n      }\n      await new Promise(resolve => setTimeout(resolve, next.value))\n    }\n    return true\n  }\n\n  async getUploadId (file, signal) {\n    const cachedResult = this.#cache.get(file.data)\n    if (cachedResult != null) {\n      return cachedResult\n    }\n\n    const promise = this.#createMultipartUpload(file, signal)\n\n    const abortPromise = () => {\n      promise.abort(signal.reason)\n      this.#cache.delete(file.data)\n    }\n    signal.addEventListener('abort', abortPromise, { once: true })\n    this.#cache.set(file.data, promise)\n    promise.then(async (result) => {\n      signal.removeEventListener('abort', abortPromise)\n      this.#setS3MultipartState(file, result)\n      this.#cache.set(file.data, result)\n    }, () => { signal.removeEventListener('abort', abortPromise) })\n\n    return promise\n  }\n\n  async abortFileUpload (file) {\n    const result = this.#cache.get(file.data)\n    if (result != null) {\n      // If the createMultipartUpload request never was made, we don't\n      // need to send the abortMultipartUpload request.\n      await this.#abortMultipartUpload(file, await result)\n    }\n  }\n\n  async uploadFile (file, chunks, signal) {\n    throwIfAborted(signal)\n    const { uploadId, key } = await this.getUploadId(file, signal)\n    throwIfAborted(signal)\n    const parts = await Promise.all(chunks.map((chunk, i) => this.uploadChunk(file, i + 1, chunk, signal)))\n    throwIfAborted(signal)\n    return this.#sendCompletionRequest(file, { key, uploadId, parts, signal }).abortOn(signal)\n  }\n\n  async resumeUploadFile (file, chunks, signal) {\n    throwIfAborted(signal)\n    const { uploadId, key } = await this.getUploadId(file, signal)\n    throwIfAborted(signal)\n    const alreadyUploadedParts = await this.#listParts(file, { uploadId, key, signal }).abortOn(signal)\n    throwIfAborted(signal)\n    const parts = await Promise.all(\n      chunks\n        .map((chunk, i) => {\n          const partNumber = i + 1\n          const alreadyUploadedInfo = alreadyUploadedParts.find(({ PartNumber }) => PartNumber === partNumber)\n          return alreadyUploadedInfo == null\n            ? this.uploadChunk(file, partNumber, chunk, signal)\n            : { PartNumber: partNumber, ETag: alreadyUploadedInfo.ETag }\n        }),\n    )\n    throwIfAborted(signal)\n    return this.#sendCompletionRequest(file, { key, uploadId, parts, signal }).abortOn(signal)\n  }\n\n  async uploadChunk (file, partNumber, body, signal) {\n    throwIfAborted(signal)\n    const { uploadId, key } = await this.getUploadId(file, signal)\n    throwIfAborted(signal)\n    for (;;) {\n      const signature = await this.#fetchSignature(file, { uploadId, key, partNumber, body, signal }).abortOn(signal)\n      throwIfAborted(signal)\n      try {\n        return {\n          PartNumber: partNumber,\n          ...await this.#uploadPartBytes(signature, body, signal).abortOn(signal),\n        }\n      } catch (err) {\n        if (!await this.#shouldRetry(err)) throw err\n      }\n    }\n  }\n}\n\nexport default class AwsS3Multipart extends BasePlugin {\n  static VERSION = packageJson.version\n\n  #queueRequestSocketToken\n\n  #companionCommunicationQueue\n\n  #client\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'uploader'\n    this.id = this.opts.id || 'AwsS3Multipart'\n    this.title = 'AWS S3 Multipart'\n    this.#client = new RequestClient(uppy, opts)\n\n    const defaultOptions = {\n      limit: 6,\n      retryDelays: [0, 1000, 3000, 5000],\n      createMultipartUpload: this.createMultipartUpload.bind(this),\n      listParts: this.listParts.bind(this),\n      abortMultipartUpload: this.abortMultipartUpload.bind(this),\n      completeMultipartUpload: this.completeMultipartUpload.bind(this),\n      signPart: this.signPart.bind(this),\n      uploadPartBytes: AwsS3Multipart.uploadPartBytes,\n      companionHeaders: {},\n    }\n\n    this.opts = { ...defaultOptions, ...opts }\n    if (opts?.prepareUploadParts != null && opts.signPart == null) {\n      this.opts.signPart = async (file, { uploadId, key, partNumber, body, signal }) => {\n        const { presignedUrls, headers } = await opts\n          .prepareUploadParts(file, { uploadId, key, parts: [{ number: partNumber, chunk: body }], signal })\n        return { url: presignedUrls?.[partNumber], headers: headers?.[partNumber] }\n      }\n    }\n\n    this.upload = this.upload.bind(this)\n\n    /**\n     * Simultaneous upload limiting is shared across all uploads with this plugin.\n     *\n     * @type {RateLimitedQueue}\n     */\n    this.requests = this.opts.rateLimitedQueue ?? new RateLimitedQueue(this.opts.limit)\n    this.#companionCommunicationQueue = new HTTPCommunicationQueue(this.requests, this.opts, this.#setS3MultipartState)\n\n    this.uploaders = Object.create(null)\n    this.uploaderEvents = Object.create(null)\n    this.uploaderSockets = Object.create(null)\n\n    this.#queueRequestSocketToken = this.requests.wrapPromiseFunction(this.#requestSocketToken, { priority: -1 })\n  }\n\n  [Symbol.for('uppy test: getClient')] () { return this.#client }\n\n  setOptions (newOptions) {\n    this.#companionCommunicationQueue.setOptions(newOptions)\n    return super.setOptions(newOptions)\n  }\n\n  /**\n   * Clean up all references for a file's upload: the MultipartUploader instance,\n   * any events related to the file, and the Companion WebSocket connection.\n   *\n   * Set `opts.abort` to tell S3 that the multipart upload is cancelled and must be removed.\n   * This should be done when the user cancels the upload, not when the upload is completed or errored.\n   */\n  resetUploaderReferences (fileID, opts = {}) {\n    if (this.uploaders[fileID]) {\n      this.uploaders[fileID].abort({ really: opts.abort || false })\n      this.uploaders[fileID] = null\n    }\n    if (this.uploaderEvents[fileID]) {\n      this.uploaderEvents[fileID].remove()\n      this.uploaderEvents[fileID] = null\n    }\n    if (this.uploaderSockets[fileID]) {\n      this.uploaderSockets[fileID].close()\n      this.uploaderSockets[fileID] = null\n    }\n  }\n\n  // TODO: make this a private method in the next major\n  assertHost (method) {\n    if (!this.opts.companionUrl) {\n      throw new Error(`Expected a \\`companionUrl\\` option containing a Companion address, or if you are not using Companion, a custom \\`${method}\\` implementation.`)\n    }\n  }\n\n  createMultipartUpload (file, signal) {\n    this.assertHost('createMultipartUpload')\n    throwIfAborted(signal)\n\n    const metadata = {}\n\n    Object.keys(file.meta || {}).forEach(key => {\n      if (file.meta[key] != null) {\n        metadata[key] = file.meta[key].toString()\n      }\n    })\n\n    return this.#client.post('s3/multipart', {\n      filename: file.name,\n      type: file.type,\n      metadata,\n    }, { signal }).then(assertServerError)\n  }\n\n  listParts (file, { key, uploadId }, signal) {\n    this.assertHost('listParts')\n    throwIfAborted(signal)\n\n    const filename = encodeURIComponent(key)\n    return this.#client.get(`s3/multipart/${uploadId}?key=${filename}`, { signal })\n      .then(assertServerError)\n  }\n\n  completeMultipartUpload (file, { key, uploadId, parts }, signal) {\n    this.assertHost('completeMultipartUpload')\n    throwIfAborted(signal)\n\n    const filename = encodeURIComponent(key)\n    const uploadIdEnc = encodeURIComponent(uploadId)\n    return this.#client.post(`s3/multipart/${uploadIdEnc}/complete?key=${filename}`, { parts }, { signal })\n      .then(assertServerError)\n  }\n\n  signPart (file, { uploadId, key, partNumber, signal }) {\n    this.assertHost('signPart')\n    throwIfAborted(signal)\n\n    if (uploadId == null || key == null || partNumber == null) {\n      throw new Error('Cannot sign without a key, an uploadId, and a partNumber')\n    }\n\n    const filename = encodeURIComponent(key)\n    return this.#client.get(`s3/multipart/${uploadId}/${partNumber}?key=${filename}`, { signal })\n      .then(assertServerError)\n  }\n\n  abortMultipartUpload (file, { key, uploadId }, signal) {\n    this.assertHost('abortMultipartUpload')\n\n    const filename = encodeURIComponent(key)\n    const uploadIdEnc = encodeURIComponent(uploadId)\n    return this.#client.delete(`s3/multipart/${uploadIdEnc}?key=${filename}`, undefined, { signal })\n      .then(assertServerError)\n  }\n\n  static async uploadPartBytes ({ url, expires, headers }, body, signal) {\n    throwIfAborted(signal)\n\n    if (url == null) {\n      throw new Error('Cannot upload to an undefined URL')\n    }\n\n    return new Promise((resolve, reject) => {\n      const xhr = new XMLHttpRequest()\n      xhr.open('PUT', url, true)\n      if (headers) {\n        Object.keys(headers).forEach((key) => {\n          xhr.setRequestHeader(key, headers[key])\n        })\n      }\n      xhr.responseType = 'text'\n      if (typeof expires === 'number') {\n        xhr.timeout = expires * 1000\n      }\n\n      function onabort () {\n        xhr.abort()\n      }\n      function cleanup () {\n        signal.removeEventListener('abort', onabort)\n      }\n      signal.addEventListener('abort', onabort)\n\n      xhr.upload.addEventListener('progress', body.onProgress)\n\n      xhr.addEventListener('abort', () => {\n        cleanup()\n\n        reject(createAbortError())\n      })\n\n      xhr.addEventListener('timeout', () => {\n        cleanup()\n\n        const error = new Error('Request has expired')\n        error.source = { status: 403 }\n        reject(error)\n      })\n      xhr.addEventListener('load', (ev) => {\n        cleanup()\n\n        if (ev.target.status === 403 && ev.target.responseText.includes('<Message>Request has expired</Message>')) {\n          const error = new Error('Request has expired')\n          error.source = ev.target\n          reject(error)\n          return\n        } if (ev.target.status < 200 || ev.target.status >= 300) {\n          const error = new Error('Non 2xx')\n          error.source = ev.target\n          reject(error)\n          return\n        }\n\n        body.onProgress?.(body.size)\n\n        // NOTE This must be allowed by CORS.\n        const etag = ev.target.getResponseHeader('ETag')\n\n        if (etag === null) {\n          reject(new Error('AwsS3/Multipart: Could not read the ETag header. This likely means CORS is not configured correctly on the S3 Bucket. See https://uppy.io/docs/aws-s3-multipart#S3-Bucket-Configuration for instructions.'))\n          return\n        }\n\n        body.onComplete?.(etag)\n        resolve({\n          ETag: etag,\n        })\n      })\n\n      xhr.addEventListener('error', (ev) => {\n        cleanup()\n\n        const error = new Error('Unknown error')\n        error.source = ev.target\n        reject(error)\n      })\n\n      xhr.send(body)\n    })\n  }\n\n  #setS3MultipartState = (file, { key, uploadId }) => {\n    const cFile = this.uppy.getFile(file.id)\n    this.uppy.setFileState(file.id, {\n      s3Multipart: {\n        ...cFile.s3Multipart,\n        key,\n        uploadId,\n      },\n    })\n  }\n\n  uploadFile (file) {\n    return new Promise((resolve, reject) => {\n      const onProgress = (bytesUploaded, bytesTotal) => {\n        this.uppy.emit('upload-progress', file, {\n          uploader: this,\n          bytesUploaded,\n          bytesTotal,\n        })\n      }\n\n      const onError = (err) => {\n        this.uppy.log(err)\n        this.uppy.emit('upload-error', file, err)\n\n        this.resetUploaderReferences(file.id)\n        reject(err)\n      }\n\n      const onSuccess = (result) => {\n        const uploadObject = upload // eslint-disable-line no-use-before-define\n        const uploadResp = {\n          body: {\n            ...result,\n          },\n          uploadURL: result.location,\n        }\n\n        this.resetUploaderReferences(file.id)\n\n        const cFile = this.uppy.getFile(file.id)\n        this.uppy.emit('upload-success', cFile || file, uploadResp)\n\n        if (result.location) {\n          this.uppy.log(`Download ${file.name} from ${result.location}`)\n        }\n\n        resolve(uploadObject)\n      }\n\n      const onPartComplete = (part) => {\n        const cFile = this.uppy.getFile(file.id)\n        if (!cFile) {\n          return\n        }\n\n        this.uppy.emit('s3-multipart:part-uploaded', cFile, part)\n      }\n\n      const upload = new MultipartUploader(file.data, {\n        // .bind to pass the file object to each handler.\n        companionComm: this.#companionCommunicationQueue,\n\n        log: (...args) => this.uppy.log(...args),\n        getChunkSize: this.opts.getChunkSize ? this.opts.getChunkSize.bind(this) : null,\n\n        onProgress,\n        onError,\n        onSuccess,\n        onPartComplete,\n\n        file,\n\n        ...file.s3Multipart,\n      })\n\n      this.uploaders[file.id] = upload\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      this.onFileRemove(file.id, (removed) => {\n        upload.abort()\n        this.resetUploaderReferences(file.id, { abort: true })\n        resolve(`upload ${removed.id} was removed`)\n      })\n\n      this.onCancelAll(file.id, ({ reason } = {}) => {\n        if (reason === 'user') {\n          upload.abort()\n          this.resetUploaderReferences(file.id, { abort: true })\n        }\n        resolve(`upload ${file.id} was canceled`)\n      })\n\n      this.onFilePause(file.id, (isPaused) => {\n        if (isPaused) {\n          upload.pause()\n        } else {\n          upload.start()\n        }\n      })\n\n      this.onPauseAll(file.id, () => {\n        upload.pause()\n      })\n\n      this.onResumeAll(file.id, () => {\n        upload.start()\n      })\n\n      // Don't double-emit upload-started for Golden Retriever-restored files that were already started\n      if (!file.progress.uploadStarted || !file.isRestored) {\n        upload.start()\n        this.uppy.emit('upload-started', file)\n      }\n    })\n  }\n\n  #requestSocketToken = async (file) => {\n    const Client = file.remote.providerOptions.provider ? Provider : RequestClient\n    const client = new Client(this.uppy, file.remote.providerOptions)\n    const opts = { ...this.opts }\n\n    if (file.tus) {\n      // Install file-specific upload overrides.\n      Object.assign(opts, file.tus)\n    }\n\n    if (file.remote.url == null) {\n      throw new Error('Cannot connect to an undefined URL')\n    }\n\n    const res = await client.post(file.remote.url, {\n      ...file.remote.body,\n      protocol: 's3-multipart',\n      size: file.data.size,\n      metadata: file.meta,\n    })\n    return res.token\n  }\n\n  async uploadRemote (file) {\n    this.resetUploaderReferences(file.id)\n\n    // Don't double-emit upload-started for Golden Retriever-restored files that were already started\n    if (!file.progress.uploadStarted || !file.isRestored) {\n      this.uppy.emit('upload-started', file)\n    }\n\n    try {\n      if (file.serverToken) {\n        return this.connectToServerSocket(file)\n      }\n      const serverToken = await this.#queueRequestSocketToken(file)\n\n      this.uppy.setFileState(file.id, { serverToken })\n      return this.connectToServerSocket(this.uppy.getFile(file.id))\n    } catch (err) {\n      this.uppy.emit('upload-error', file, err)\n      throw err\n    }\n  }\n\n  async connectToServerSocket (file) {\n    return new Promise((resolve, reject) => {\n      let queuedRequest\n\n      const token = file.serverToken\n      const host = getSocketHost(file.remote.companionUrl)\n      const socket = new Socket({ target: `${host}/api/${token}` })\n      this.uploaderSockets[file.id] = socket\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      this.onFileRemove(file.id, () => {\n        queuedRequest.abort()\n        socket.send('cancel', {})\n        this.resetUploaderReferences(file.id, { abort: true })\n        resolve(`upload ${file.id} was removed`)\n      })\n\n      this.onFilePause(file.id, (isPaused) => {\n        if (isPaused) {\n          // Remove this file from the queue so another file can start in its place.\n          queuedRequest.abort()\n          socket.send('pause', {})\n        } else {\n          // Resuming an upload should be queued, else you could pause and then\n          // resume a queued upload to make it skip the queue.\n          queuedRequest.abort()\n          queuedRequest = this.requests.run(() => {\n            socket.send('resume', {})\n            return () => {}\n          })\n        }\n      })\n\n      this.onPauseAll(file.id, () => {\n        queuedRequest.abort()\n        socket.send('pause', {})\n      })\n\n      this.onCancelAll(file.id, ({ reason } = {}) => {\n        if (reason === 'user') {\n          queuedRequest.abort()\n          socket.send('cancel', {})\n          this.resetUploaderReferences(file.id)\n        }\n        resolve(`upload ${file.id} was canceled`)\n      })\n\n      this.onResumeAll(file.id, () => {\n        queuedRequest.abort()\n        if (file.error) {\n          socket.send('pause', {})\n        }\n        queuedRequest = this.requests.run(() => {\n          socket.send('resume', {})\n        })\n      })\n\n      this.onRetry(file.id, () => {\n        // Only do the retry if the upload is actually in progress;\n        // else we could try to send these messages when the upload is still queued.\n        // We may need a better check for this since the socket may also be closed\n        // for other reasons, like network failures.\n        if (socket.isOpen) {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        }\n      })\n\n      this.onRetryAll(file.id, () => {\n        if (socket.isOpen) {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        }\n      })\n\n      socket.on('progress', (progressData) => emitSocketProgress(this, progressData, file))\n\n      socket.on('error', (errData) => {\n        this.uppy.emit('upload-error', file, new Error(errData.error))\n        this.resetUploaderReferences(file.id)\n        queuedRequest.done()\n        reject(new Error(errData.error))\n      })\n\n      socket.on('success', (data) => {\n        const uploadResp = {\n          uploadURL: data.url,\n        }\n\n        this.uppy.emit('upload-success', file, uploadResp)\n        this.resetUploaderReferences(file.id)\n        queuedRequest.done()\n        resolve()\n      })\n\n      queuedRequest = this.requests.run(() => {\n        if (file.isPaused) {\n          socket.send('pause', {})\n        }\n\n        return () => {}\n      })\n    })\n  }\n\n  async upload (fileIDs) {\n    if (fileIDs.length === 0) return undefined\n\n    const promises = fileIDs.map((id) => {\n      const file = this.uppy.getFile(id)\n      if (file.isRemote) {\n        return this.uploadRemote(file)\n      }\n      return this.uploadFile(file)\n    })\n\n    return Promise.all(promises)\n  }\n\n  #setCompanionHeaders = () => {\n    this.#client.setCompanionHeaders(this.opts.companionHeaders)\n  }\n\n  onFileRemove (fileID, cb) {\n    this.uploaderEvents[fileID].on('file-removed', (file) => {\n      if (fileID === file.id) cb(file.id)\n    })\n  }\n\n  onFilePause (fileID, cb) {\n    this.uploaderEvents[fileID].on('upload-pause', (targetFileID, isPaused) => {\n      if (fileID === targetFileID) {\n        cb(isPaused)\n      }\n    })\n  }\n\n  onRetry (fileID, cb) {\n    this.uploaderEvents[fileID].on('upload-retry', (targetFileID) => {\n      if (fileID === targetFileID) {\n        cb()\n      }\n    })\n  }\n\n  onRetryAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('retry-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onPauseAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('pause-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onCancelAll (fileID, eventHandler) {\n    this.uploaderEvents[fileID].on('cancel-all', (...args) => {\n      if (!this.uppy.getFile(fileID)) return\n      eventHandler(...args)\n    })\n  }\n\n  onResumeAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('resume-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  install () {\n    const { capabilities } = this.uppy.getState()\n    this.uppy.setState({\n      capabilities: {\n        ...capabilities,\n        resumableUploads: true,\n      },\n    })\n    this.uppy.addPreProcessor(this.#setCompanionHeaders)\n    this.uppy.addUploader(this.upload)\n  }\n\n  uninstall () {\n    const { capabilities } = this.uppy.getState()\n    this.uppy.setState({\n      capabilities: {\n        ...capabilities,\n        resumableUploads: false,\n      },\n    })\n    this.uppy.removePreProcessor(this.#setCompanionHeaders)\n    this.uppy.removeUploader(this.upload)\n  }\n}\n"],"mappings":"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"}